---
title: "loan_plots"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{loan_plots}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(stress.test.plot.report)
```

To save a plot, right-click on the plot and choose "save as". Then in the window that opens,
write a name for the image and add ".png" at the end. The image can then be found in the destination
directory.


Load the data :

-   Bonds dataset should be in csv format, and follow the same columns structure as the example template
-   Crispy outputs files should be named with this nomenclature : "crispy_output_RUN_ID.csv" where "RUN_ID" is the name of the run, and should be unique accross all crispy files.

Fill in the input path for the bond dataset and the stress test directory containing multiple trisk runs :

```{r}
loans_input_path <- file.path(getwd(), "data", "indonesia_sample","loans_template.csv")
trisk_output_path <- file.path(getwd(), "data", "indonesia_sample", "stress_test_runs")
```

```{r, results=FALSE, warning=FALSE, echo=FALSE}
## LOAD Bond data
loans_data <- load_loans_data(loans_input_path)
# LOAD in different crispy runs
all_crispy <- load_multi_crispy_outputs(trisk_output_path)
```

Available runs :

```{r, echo=FALSE}
print(unique(all_crispy$run_id))
```

Selected runs :

```{r, echo=FALSE}
# comment with "#" at the start of a line to ignore this run
# the last uncommented run id should not be followed by a comma

plot_run <- c(
"standard_WEO2021_SDS_AsiaPacific_no_carbon_tax",
"standard_NGFS2021_MESSAGE_B2DS_Global_no_carbon_tax",
"standard_NGFS2021_GCAM_B2DS_Indonesia_no_carbon_tax",
"shock_year_NGFS2021_GCAM_B2DS_Indonesia_no_carbon_tax",
"standard_NGFS2021_GCAM_B2DS_Indonesia_NDC_Indonesia_moderate",
"standard_NGFS2021_GCAM_B2DS_Indonesia_NZ2050_Indonesia_market_assumption"
)
print(plot_run)
```

Select plot parameters :

New color gradients can be generated with this website : <https://colordesigner.io/gradient-generator>

```{r}
plot_shock_year <- c(2025, 2030, 2035)
color_gradient <- list(pd_baseline=c("#999df6", "#7d81fc", "#6063ff", "#3f42ff", "#000fff"),
                       pd_shock=c("#FFC0C0", "#FF8888", "#FF6666", "#FF4444", "#FF2222", "#FF0000"),
                       pd_difference=c("#ffffd2", "#fefebb", "#fdfda2", "#fbfb89", "#fafa6e"))
```

```{r, echo=FALSE}
crispy_plot <- all_crispy %>%
  dplyr::filter(shock_year %in% plot_shock_year,
                run_id %in% plot_run)

scenario_weights <- compute_portfolio_weights(loans_data)
```

# <span style="color: red;">Transition risk shock plots</span>

Expected loss for a company in a given bank and sector is computed as follows:

$$
EL_{company} = pd_{shock} * exposure_{company} * lgd_{company} * weight_{company}
$$

with weight for each sector as :

$$
weight_{company} = \frac{company\ sector\ exposures}{total\ portfolio\ sector\ exposures}
$$

The EL for each companies are then summed independantly for each sector and bank to produce the plots.

```{r, echo=FALSE, fig.height=12}
plot_list <- make_expected_loss_plot(
  crispy_plot,
  loans_data,
  scenario_weights,
  "shock_year",
  color_gradient
  )
for (plot_name in names(plot_list)){
  plot(plot_list[[plot_name]])
}
```

# <span style="color: red;">Average PD plots</span>

The average PD is computed for each sector and bank independantly using this formula :

$$
average\ pd_{sector} = \frac{\sum{(pd_{company} * weight_{company})}}{N_{companies}}
$$


```{r, echo=FALSE, fig.height=12}
plot_list <- make_average_pd_shock_plots(
  crispy_plot,
  loans_data,
  scenario_weights,
  "shock_year",
  color_gradient
  )
for (plot_name in names(plot_list)){
  plot(plot_list[[plot_name]])
}
```
